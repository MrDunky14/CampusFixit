<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusFixit ‚Äî Maintenance Ticket System</title>
  <style>
    /* ============================================================
       CampusFixit ‚Äî Modern IT / B.Tech Theme Overhaul
       ============================================================ */
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

    /* ---------- CSS Variables / Theming ---------- */
    :root {
      --bg-body: #f8fafc;
      --bg-card: rgba(255, 255, 255, 0.85);
      --bg-sidebar: rgba(255, 255, 255, 0.6);
      --bg-input: #f1f5f9;
      --border: rgba(226, 232, 240, 0.8);
      --border-strong: #cbd5e1;
      
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      
      /* Gradients & Accents */
      --accent-primary: #4f46e5;
      --accent-secondary: #0ea5e9;
      --accent-grad: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      --accent-hover: linear-gradient(135deg, #4338ca, #0284c7);
      --accent-light: #e0e7ff;
      
      /* Shadows & Curves */
      --shadow-sm: 0 2px 8px rgba(0,0,0,.04);
      --shadow-md: 0 8px 24px rgba(0,0,0,.06);
      --shadow-lg: 0 20px 40px rgba(0,0,0,.1);
      --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.2);
      --radius-lg: 24px;
      --radius: 16px;
      --radius-sm: 10px;
      
      /* Status Colors */
      --priority-high: #ef4444;
      --priority-medium: #f59e0b;
      --priority-low: #10b981;
      --status-pending: #f59e0b;
      --status-pending-bg: #fef3c7;
      --status-assigned: #3b82f6;
      --status-assigned-bg: #dbeafe;
      --status-inprogress: #8b5cf6;
      --status-inprogress-bg: #ede9fe;
      --status-fixed: #06b6d4;
      --status-fixed-bg: #cffafe;
      --status-verified: #10b981;
      --status-verified-bg: #d1fae5;
      --status-reopened: #ef4444;
      --status-reopened-bg: #fee2e2;
      
      --toast-bg: rgba(15, 23, 42, 0.95);
      --toast-text: #f8fafc;
      --transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.dark {
      --bg-body: #09090b;
      --bg-card: rgba(24, 24, 27, 0.7);
      --bg-sidebar: rgba(24, 24, 27, 0.5);
      --bg-input: rgba(39, 39, 42, 0.6);
      --border: rgba(63, 63, 70, 0.5);
      --border-strong: #52525b;
      
      --text-primary: #f8fafc;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      
      --accent-primary: #6366f1;
      --accent-secondary: #22d3ee;
      --accent-light: rgba(99, 102, 241, 0.15);
      
      --shadow-sm: 0 4px 12px rgba(0,0,0,.3);
      --shadow-md: 0 10px 30px rgba(0,0,0,.5);
      --shadow-glow: 0 0 25px rgba(99, 102, 241, 0.2);
      
      --toast-bg: rgba(248, 250, 252, 0.95);
      --toast-text: #0f172a;
      
      --status-pending-bg: rgba(245, 158, 11, 0.15);
      --status-assigned-bg: rgba(59, 130, 246, 0.15);
      --status-inprogress-bg: rgba(139, 92, 246, 0.15);
      --status-fixed-bg: rgba(6, 182, 212, 0.15);
      --status-verified-bg: rgba(16, 185, 129, 0.15);
      --status-reopened-bg: rgba(239, 68, 68, 0.15);
    }

    /* ---------- Custom Scrollbar ---------- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ---------- Reset & Base ---------- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-body);
      /* Tech Grid Pattern */
      background-image: radial-gradient(var(--border) 1px, transparent 1px);
      background-size: 24px 24px;
      color: var(--text-primary);
      min-height: 100vh;
      transition: background-color var(--transition), color var(--transition);
      position: relative;
      overflow-x: hidden;
    }

    /* Glowing Ambient Orbs */
    body::before, body::after {
      content: ''; position: fixed;
      width: 500px; height: 500px;
      border-radius: 50%; filter: blur(120px);
      opacity: 0.15; z-index: -1; pointer-events: none;
      transition: background var(--transition);
    }
    body::before { top: -150px; left: -150px; background: var(--accent-primary); }
    body::after { bottom: -150px; right: -150px; background: var(--accent-secondary); }

    .hidden { display: none !important; }

    /* ---------- Header ---------- */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 32px;
      background: var(--bg-sidebar);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .logo { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.03em; }
    .logo .accent {
      background: var(--accent-grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .role-switcher {
      display: flex; gap: 4px; background: var(--bg-input);
      padding: 4px; border-radius: 99px; border: 1px solid var(--border);
    }
    .role-btn {
      padding: 8px 24px; font-size: 0.9rem; font-weight: 700;
      border: none; border-radius: 99px; cursor: pointer; background: transparent;
      color: var(--text-secondary); transition: var(--transition);
    }
    .role-btn:hover { color: var(--text-primary); }
    .role-btn.active {
      background: var(--bg-card); color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    .dark .role-btn.active { background: var(--text-primary); color: var(--bg-body); }

    .dark-toggle {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 50%; width: 44px; height: 44px;
      font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: var(--transition);
    }
    .dark-toggle:hover {
      transform: rotate(15deg) scale(1.05);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-glow);
    }

    /* ---------- Main Layout ---------- */
    .main-layout { display: flex; gap: 0; min-height: calc(100vh - 77px); }

    /* Sidebar Form */
    .sidebar {
      width: 380px; min-width: 350px;
      background: var(--bg-sidebar); backdrop-filter: blur(12px);
      border-right: 1px solid var(--border); padding: 32px 28px;
      position: sticky; top: 77px; height: calc(100vh - 77px);
      overflow-y: auto; box-shadow: var(--shadow-md);
    }

    .form-title {
      font-size: 1.3rem; font-weight: 800; margin-bottom: 24px; color: var(--text-primary);
    }

    .ticket-form label {
      display: block; font-size: 0.8rem; font-weight: 700;
      color: var(--text-secondary); margin: 16px 0 6px;
      text-transform: uppercase; letter-spacing: 0.05em;
    }

    .ticket-form select, .ticket-form input[type="text"], .ticket-form textarea {
      width: 100%; padding: 12px 16px; font-size: 0.95rem;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text-primary);
      outline: none; font-family: inherit; font-weight: 500;
      transition: var(--transition);
    }
    .ticket-form select:focus, .ticket-form input[type="text"]:focus, .ticket-form textarea:focus {
      border-color: var(--accent-primary); background: var(--bg-card);
      box-shadow: 0 0 0 4px rgba(79,70,229,0.1);
    }
    .ticket-form textarea { resize: vertical; min-height: 90px; }

    .location-wrap { display: flex; gap: 8px; }
    .location-wrap input { flex: 1; }

    .scan-qr-btn {
      white-space: nowrap; padding: 0 16px; font-size: 0.85rem; font-weight: 700;
      border: 1px solid var(--accent-primary); border-radius: var(--radius-sm);
      background: transparent; color: var(--accent-primary); cursor: pointer;
      transition: var(--transition);
    }
    .scan-qr-btn:hover { background: var(--accent-primary); color: #fff; box-shadow: var(--shadow-glow); }
    .scan-qr-btn.scanning { opacity: 0.7; pointer-events: none; }
    
    .qr-spinner {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid var(--text-muted); border-top-color: var(--accent-primary);
      border-radius: 50%; animation: spin .6s linear infinite;
      vertical-align: middle; margin-right: 4px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .btn-submit {
      margin-top: 24px; width: 100%; padding: 14px; font-size: 1rem; font-weight: 800;
      border: none; border-radius: var(--radius-sm);
      background: var(--accent-grad); color: #fff; cursor: pointer;
      box-shadow: var(--shadow-md); transition: var(--transition);
    }
    .btn-submit:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: var(--shadow-glow); }

    /* Dashboard */
    .dashboard { flex: 1; padding: 32px 40px; overflow-y: auto; }
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .dash-title { font-size: 1.4rem; font-weight: 800; }

    .filter-group {
      display: flex; gap: 4px; background: var(--bg-card); padding: 4px;
      border-radius: 99px; border: 1px solid var(--border);
      box-shadow: var(--shadow-sm); flex-wrap: wrap; backdrop-filter: blur(10px);
    }
    .filter-btn {
      padding: 8px 16px; font-size: 0.85rem; font-weight: 700;
      border: none; border-radius: 99px; cursor: pointer;
      background: transparent; color: var(--text-secondary);
      transition: var(--transition); white-space: nowrap;
    }
    .filter-btn:hover { background: var(--accent-light); color: var(--text-primary); }
    .filter-btn.active { background: var(--accent-grad); color: #fff; box-shadow: var(--shadow-sm); }

    /* Tickets Grid */
    .tickets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
    .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--text-muted); font-size: 1.1rem; font-weight: 600; }

    /* Modern Ticket Card */
    .ticket-card {
      background: var(--bg-card); border-radius: var(--radius-lg);
      border: 1px solid var(--border); box-shadow: var(--shadow-sm);
      padding: 24px; display: flex; flex-direction: column; gap: 12px;
      position: relative; overflow: hidden;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      transition: var(--transition); animation: cardIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes cardIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .ticket-card:hover { box-shadow: var(--shadow-md); transform: translateY(-4px); border-color: var(--border-strong); }

    /* Glowing Left Priority Border */
    .ticket-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; border-radius: var(--radius-lg) 0 0 var(--radius-lg); }
    .ticket-card.priority-High::before   { background: linear-gradient(to bottom, #ef4444, #f87171); box-shadow: 2px 0 12px rgba(239,68,68,0.4); }
    .ticket-card.priority-Medium::before { background: linear-gradient(to bottom, #f59e0b, #fbbf24); box-shadow: 2px 0 12px rgba(245,158,11,0.4); }
    .ticket-card.priority-Low::before    { background: linear-gradient(to bottom, #10b981, #34d399); box-shadow: 2px 0 12px rgba(16,185,129,0.4); }

    .card-top { display: flex; align-items: center; justify-content: space-between; }
    .ticket-id {
      font-size: 0.75rem; font-weight: 800; color: var(--accent-primary);
      background: var(--accent-light); padding: 4px 10px; border-radius: 6px; letter-spacing: 0.05em;
    }
    .ticket-time { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }

    .card-category { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); }
    .card-location { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
    .card-reporter { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; font-style: italic; }
    .card-desc { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; word-break: break-word; }

    .card-assigned {
      font-size: 0.8rem; color: var(--accent-secondary); font-weight: 700;
      display: inline-block; background: var(--status-fixed-bg); padding: 4px 10px; border-radius: 6px;
    }

    .card-bottom { display: flex; align-items: center; justify-content: space-between; margin-top: auto; padding-top: 8px; flex-wrap: wrap; gap: 8px; }

    /* Status Badges */
    .status-badge {
      display: inline-block; padding: 6px 14px; font-size: 0.75rem;
      font-weight: 800; border-radius: 99px; text-transform: uppercase; letter-spacing: 0.05em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .status-Pending     { background: var(--status-pending-bg);    color: var(--status-pending); }
    .status-Assigned    { background: var(--status-assigned-bg);   color: var(--status-assigned); }
    .status-In\.Progress, .status-In-Progress { background: var(--status-inprogress-bg); color: var(--status-inprogress); }
    .status-Fixed       { background: var(--status-fixed-bg);      color: var(--status-fixed); }
    .status-Verified    { background: var(--status-verified-bg);   color: var(--status-verified); }
    .status-Reopened    { background: var(--status-reopened-bg);   color: var(--status-reopened); }

    .btn-verify {
      padding: 6px 16px; font-size: 0.85rem; font-weight: 800;
      border: none; border-radius: 8px; background: var(--status-verified); color: #fff;
      cursor: pointer; transition: var(--transition); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-verify:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4); }

    .delete-btn {
      background: var(--bg-input); border: 1px solid var(--border); cursor: pointer; font-size: 1rem;
      color: var(--text-muted); padding: 6px 8px; border-radius: 8px; transition: var(--transition);
    }
    .delete-btn:hover { color: var(--priority-high); background: var(--status-reopened-bg); border-color: var(--priority-high); }

    .verified-stamp {
      font-size: 0.8rem; font-weight: 800; color: var(--status-verified);
      display: flex; align-items: center; gap: 6px;
      background: var(--status-verified-bg); padding: 6px 12px; border-radius: 8px;
    }
    .verified-stamp .star-display { color: #f59e0b; letter-spacing: 2px; }

    /* Voting */
    .card-vote-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
    .btn-upvote {
      display: flex; align-items: center; gap: 6px; padding: 6px 14px; font-size: 0.85rem; font-weight: 800;
      border: 1px solid var(--border-strong); border-radius: 99px; background: var(--bg-card); color: var(--text-secondary);
      cursor: pointer; transition: var(--transition);
    }
    .btn-upvote:hover { border-color: var(--accent-primary); color: var(--accent-primary); background: var(--accent-light); transform: translateY(-2px); }
    .btn-upvote.voted { border-color: var(--accent-primary); color: #fff; background: var(--accent-primary); }
    
    .btn-upvote.vote-warm { border-color: var(--priority-medium); color: var(--priority-medium); }
    .btn-upvote.vote-warm.voted { background: var(--priority-medium); color: #fff; }
    .btn-upvote.vote-hot { border-color: var(--priority-high); color: var(--priority-high); }
    .btn-upvote.vote-hot.voted { background: var(--priority-high); color: #fff; }

    .upvote-arrow { transition: transform 0.2s; }
    .btn-upvote:hover .upvote-arrow { transform: translateY(-3px); }
    .upvote-count { font-size: .85rem; font-weight: 800; min-width: 14px; text-align: center; }

    .vote-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
    .vote-label.vote-warm { color: var(--priority-medium); }
    .vote-label.vote-hot  { color: var(--priority-high); font-weight: 800; }

    /* ---------- STAFF VIEW ---------- */
    .staff-layout { padding: 32px 40px; min-height: calc(100vh - 77px); }

    /* Stats Bar */
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 24px; text-align: center; box-shadow: var(--shadow-sm);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: var(--transition);
    }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--border-strong); }
    
    .stat-number { font-size: 2.5rem; font-weight: 800; line-height: 1; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-top: 8px; text-transform: uppercase; letter-spacing: 0.05em; }

    .stat-pending-card .stat-number  { background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; }
    .stat-progress-card .stat-number { background: linear-gradient(135deg, #8b5cf6, #a78bfa); -webkit-background-clip: text; }
    .stat-fixed-card .stat-number    { background: linear-gradient(135deg, #06b6d4, #22d3ee); -webkit-background-clip: text; }
    .stat-verified-card .stat-number { background: linear-gradient(135deg, #10b981, #34d399); -webkit-background-clip: text; }

    /* Staff Toolbar */
    .staff-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .staff-toolbar-right { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .staff-name-wrap {
      display: flex; align-items: center; gap: 8px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 99px; padding: 6px 16px; box-shadow: var(--shadow-sm);
    }
    .staff-name-input { border: none; background: transparent; font-size: 0.95rem; font-weight: 600; color: var(--text-primary); outline: none; width: 160px; font-family: inherit; }

    /* Floating Staff Table */
    .staff-table-wrap { background: transparent; border: none; overflow-x: auto; }
    .staff-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; font-size: 0.9rem; }
    .staff-table thead th { padding: 0 20px 8px; text-align: left; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); border: none; white-space: nowrap; }
    .staff-table tbody tr { background: var(--bg-card); box-shadow: var(--shadow-sm); transition: var(--transition); }
    .staff-table tbody tr td:first-child { border-top-left-radius: var(--radius); border-bottom-left-radius: var(--radius); }
    .staff-table tbody tr td:last-child { border-top-right-radius: var(--radius); border-bottom-right-radius: var(--radius); }
    .staff-table tbody tr:hover { transform: scale(1.01); box-shadow: var(--shadow-md); background: var(--bg-sidebar); }
    .staff-table td { padding: 16px 20px; border: none; vertical-align: middle; color: var(--text-primary); font-weight: 500; }

    .priority-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    .priority-dot.High   { background: var(--priority-high); box-shadow: 0 0 10px rgba(239,68,68,0.5); }
    .priority-dot.Medium { background: var(--priority-medium); box-shadow: 0 0 10px rgba(245,158,11,0.5); }
    .priority-dot.Low    { background: var(--priority-low); }

    .vote-count-badge {
      display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; font-size: 0.8rem; font-weight: 800;
      border-radius: 8px; background: var(--bg-input); color: var(--text-secondary);
    }
    .vote-count-badge.vote-warm { background: var(--status-pending-bg); color: var(--priority-medium); }
    .vote-count-badge.vote-hot { background: var(--status-reopened-bg); color: var(--priority-high); }
    .vote-cell { white-space: nowrap; }

    /* Staff Action Buttons */
    .staff-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-btn {
      padding: 8px 14px; font-size: 0.8rem; font-weight: 800; border: none; border-radius: 8px;
      cursor: pointer; background: var(--bg-input); color: var(--text-secondary);
      transition: var(--transition); white-space: nowrap;
    }
    .action-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .action-btn.assign   { background: var(--status-assigned-bg); color: var(--status-assigned); }
    .action-btn.progress { background: var(--status-inprogress-bg); color: var(--status-inprogress); }
    .action-btn.done     { background: var(--status-fixed-bg); color: var(--status-fixed); }
    .action-btn.notes    { background: var(--accent-light); color: var(--accent-primary); }
    .action-btn.assign:hover   { background: var(--status-assigned); color: #fff; }
    .action-btn.progress:hover { background: var(--status-inprogress); color: #fff; }
    .action-btn.done:hover     { background: var(--status-fixed); color: #fff; }
    .action-btn.notes:hover    { background: var(--accent-primary); color: #fff; }

    /* ---------- MODALS ---------- */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; backdrop-filter: blur(0px); } to { opacity: 1; backdrop-filter: blur(8px); } }

    .modal {
      background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-strong);
      padding: 32px; width: 460px; max-width: 92vw; box-shadow: var(--shadow-lg), 0 0 40px rgba(0,0,0,0.2);
      animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 85vh; overflow-y: auto;
    }
    .modal-wide { width: 560px; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    .modal-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 8px; }
    .modal-subtitle { font-size: 0.9rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 24px; padding: 8px; background: var(--accent-light); border-radius: 8px; }

    .modal-body label { display: block; font-size: 0.8rem; font-weight: 800; color: var(--text-secondary); margin-bottom: 8px; margin-top: 16px; text-transform: uppercase; letter-spacing: 0.05em; }
    .modal-body textarea {
      width: 100%; padding: 12px; font-size: 0.95rem; font-weight: 500;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text-primary); outline: none; font-family: inherit; resize: vertical; transition: var(--transition);
    }
    .modal-body textarea:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 4px rgba(79,70,229,0.1); }

    .note-input-row { display: flex; gap: 12px; align-items: flex-end; }
    .note-input-row textarea { flex: 1; }
    .btn-add-note {
      padding: 12px 20px; font-size: 0.9rem; font-weight: 800; border: none; border-radius: var(--radius-sm);
      background: var(--accent-grad); color: #fff; cursor: pointer; box-shadow: var(--shadow-sm); transition: var(--transition);
    }
    .btn-add-note:hover { transform: translateY(-2px); box-shadow: var(--shadow-glow); }

    .modal-actions { display: flex; gap: 12px; margin-top: 28px; flex-wrap: wrap; }
    .modal-actions button {
      flex: 1; padding: 12px; font-size: 0.95rem; font-weight: 800; border: none; border-radius: var(--radius-sm);
      cursor: pointer; transition: var(--transition);
    }
    .btn-verify-accept { background: var(--status-verified); color: #fff; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .btn-verify-accept:hover { background: #059669; transform: translateY(-2px); }
    .btn-verify-reject { background: var(--status-reopened); color: #fff; box-shadow: 0 4px 12px rgba(239,68,68,0.3); }
    .btn-verify-reject:hover { background: #dc2626; transform: translateY(-2px); }
    .btn-verify-cancel { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-strong) !important; }
    .btn-verify-cancel:hover { background: var(--border); }

    /* Activity Log */
    .activity-log { margin-top: 20px; max-height: 250px; overflow-y: auto; padding-right: 8px; }
    .log-entry {
      padding: 12px 16px; border-left: 4px solid var(--accent-primary); margin-bottom: 12px;
      background: var(--bg-input); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 0.85rem; font-weight: 500;
    }
    .log-entry .log-time { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 4px; }
    .log-entry .log-actor { font-weight: 800; color: var(--accent-primary); }
    .log-entry.log-system { border-left-color: var(--text-muted); }
    .log-entry.log-note   { border-left-color: var(--status-assigned); }

    /* Star Rating */
    .stars { display: flex; gap: 8px; margin-top: 8px; }
    .star { font-size: 2rem; cursor: pointer; color: var(--border-strong); transition: var(--transition); }
    .star:hover, .star.active { color: #f59e0b; transform: scale(1.15) rotate(5deg); text-shadow: 0 0 10px rgba(245,158,11,0.4); }

    /* ---------- Toast ---------- */
    #toast-container { position: fixed; top: 90px; right: 32px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast {
      pointer-events: auto; background: var(--toast-bg); color: var(--toast-text);
      padding: 14px 24px; border-radius: var(--radius-sm); font-size: 0.95rem; font-weight: 700;
      box-shadow: var(--shadow-lg); animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), toastOut 0.4s ease 3s forwards;
      max-width: 380px; border-left: 4px solid var(--accent-primary);
    }
    @keyframes toastIn  { from { opacity: 0; transform: translateX(60px) scale(0.9); } to { opacity: 1; transform: translateX(0) scale(1); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0) scale(1); } to { opacity: 0; transform: translateX(60px) scale(0.9); } }

    /* ---------- Responsive ---------- */
    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
      .sidebar { width: 100%; min-width: unset; position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 24px; }
      .dashboard, .staff-layout { padding: 24px; }
      .tickets-grid { grid-template-columns: 1fr; }
      .header { padding: 16px 24px; }
      .role-switcher { width: 100%; }
      .role-btn { flex: 1; text-align: center; }
      .dash-header { flex-direction: column; align-items: flex-start; }
      .staff-toolbar { flex-direction: column; align-items: flex-start; }
      .staff-toolbar-right { flex-direction: column; width: 100%; }
      .stats-bar { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- ===== Verification Modal ===== -->
  <div id="verify-modal" class="modal-overlay hidden">
    <div class="modal">
      <h3 class="modal-title">‚úÖ Verify Completed Work</h3>
      <p class="modal-subtitle" id="modal-ticket-info"></p>
      <div class="modal-body">
        <label for="verify-comment">Comment (optional)</label>
        <textarea id="verify-comment" rows="3" placeholder="Any feedback on the repair‚Ä¶"></textarea>
        <div class="modal-rating">
          <label>Rate the fix</label>
          <div class="stars" id="star-rating">
            <span class="star" data-val="1">‚òÖ</span>
            <span class="star" data-val="2">‚òÖ</span>
            <span class="star" data-val="3">‚òÖ</span>
            <span class="star" data-val="4">‚òÖ</span>
            <span class="star" data-val="5">‚òÖ</span>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="verify-accept" class="btn-verify-accept">‚úÖ Confirm Fixed</button>
        <button id="verify-reject" class="btn-verify-reject">üîÑ Reopen Issue</button>
        <button id="verify-cancel" class="btn-verify-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ===== Staff Notes Modal ===== -->
  <div id="notes-modal" class="modal-overlay hidden">
    <div class="modal modal-wide">
      <h3 class="modal-title">üìù Staff Notes & Activity Log</h3>
      <p class="modal-subtitle" id="notes-ticket-info"></p>
      <div class="modal-body">
        <label for="staff-note-input">Add a note</label>
        <div class="note-input-row">
          <textarea id="staff-note-input" rows="2" placeholder="e.g. Ordered replacement part‚Ä¶"></textarea>
          <button id="add-note-btn" class="btn-add-note">+ Add</button>
        </div>
        <div id="activity-log" class="activity-log"></div>
      </div>
      <div class="modal-actions">
        <button id="notes-close" class="btn-verify-cancel">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== Header ===== -->
  <header class="header">
    <div class="header-left">
      <h1 class="logo">üè´ Campus<span class="accent">Fixit</span></h1>
    </div>
    <div class="header-center">
      <div class="role-switcher">
        <button class="role-btn active" data-role="student">üéì Student</button>
        <button class="role-btn" data-role="staff">üîß Staff</button>
      </div>
    </div>
    <div class="header-right">
      <button id="dark-toggle" class="dark-toggle" title="Toggle Dark Mode">
        <span id="dark-icon">üåô</span>
      </button>
    </div>
  </header>

  <!-- ============================================================
       STUDENT VIEW
       ============================================================ -->
  <main id="student-view" class="main-layout">
    <!-- LEFT SIDEBAR ‚Äî Submission Form -->
    <aside class="sidebar">
      <form id="ticket-form" class="ticket-form">
        <h2 class="form-title">üìù Report an Issue</h2>

        <!-- Reporter Name -->
        <label for="reporter">Your Name</label>
        <input type="text" id="reporter" placeholder="e.g. Arjun Mehta" required />

        <!-- Category -->
        <label for="category">Category</label>
        <select id="category" required>
          <option value="" disabled selected>Select a category‚Ä¶</option>
          <option value="üíª IT/Projector">üíª IT/Projector</option>
          <option value="‚ùÑÔ∏è AC/Ventilation">‚ùÑÔ∏è AC/Ventilation</option>
          <option value="ü™ë Furniture">ü™ë Furniture</option>
          <option value="üí° Lighting">üí° Lighting</option>
          <option value="üöø Plumbing">üöø Plumbing</option>
          <option value="üì∂ WiFi/Network">üì∂ WiFi/Network</option>
          <option value="üîå Electrical">üîå Electrical</option>
          <option value="üßπ Cleaning">üßπ Cleaning</option>
          <option value="üîß Other">üîß Other</option>
        </select>

        <!-- Location -->
        <label for="location">Location</label>
        <div class="location-wrap">
          <input type="text" id="location" placeholder="e.g. Lab 4, Block B" required />
          <button type="button" id="scan-qr" class="scan-qr-btn" title="Scan Room QR">
            üì∑ Scan QR
          </button>
        </div>

        <!-- Priority -->
        <label for="priority">Priority</label>
        <select id="priority" required>
          <option value="" disabled selected>Select priority‚Ä¶</option>
          <option value="Low">üü¢ Low</option>
          <option value="Medium">üü° Medium</option>
          <option value="High">üî¥ High</option>
        </select>

        <!-- Description -->
        <label for="description">Problem Description</label>
        <textarea id="description" rows="4" placeholder="Describe the issue in detail‚Ä¶" required></textarea>

        <!-- Submit -->
        <button type="submit" class="btn-submit">üöÄ Submit Ticket</button>
      </form>
    </aside>

    <!-- RIGHT MAIN AREA ‚Äî Student Dashboard -->
    <section class="dashboard">
      <div class="dash-header">
        <h2 class="dash-title">üìã My Tickets</h2>
        <div class="filter-group" id="student-filters">
          <button class="filter-btn active" data-filter="All">All</button>
          <button class="filter-btn" data-filter="Pending">Pending</button>
          <button class="filter-btn" data-filter="Assigned">Assigned</button>
          <button class="filter-btn" data-filter="In Progress">In Progress</button>
          <button class="filter-btn" data-filter="Fixed">Fixed</button>
          <button class="filter-btn" data-filter="Verified">Verified</button>
        </div>
      </div>

      <div id="tickets-grid" class="tickets-grid">
        <div class="empty-state" id="empty-state">
          <p>üéâ No tickets yet ‚Äî the campus is running smoothly!</p>
        </div>
      </div>
    </section>
  </main>

  <!-- ============================================================
       STAFF VIEW
       ============================================================ -->
  <main id="staff-view" class="staff-layout hidden">
    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card stat-total">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card stat-pending-card">
        <div class="stat-number" id="stat-pending">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card stat-progress-card">
        <div class="stat-number" id="stat-progress">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card stat-fixed-card">
        <div class="stat-number" id="stat-fixed">0</div>
        <div class="stat-label">Awaiting Verify</div>
      </div>
      <div class="stat-card stat-verified-card">
        <div class="stat-number" id="stat-verified">0</div>
        <div class="stat-label">Verified</div>
      </div>
    </div>

    <!-- Staff toolbar -->
    <div class="staff-toolbar">
      <h2 class="dash-title">üîß Staff Ticket Queue</h2>
      <div class="staff-toolbar-right">
        <div class="staff-name-wrap">
          <label for="staff-name" class="staff-name-label">üë§</label>
          <input type="text" id="staff-name" class="staff-name-input" placeholder="Your name‚Ä¶" />
        </div>
        <div class="filter-group" id="staff-filters">
          <button class="filter-btn active" data-filter="All">All</button>
          <button class="filter-btn" data-filter="Pending">Pending</button>
          <button class="filter-btn" data-filter="Assigned">Assigned</button>
          <button class="filter-btn" data-filter="In Progress">In Progress</button>
          <button class="filter-btn" data-filter="Fixed">Fixed</button>
          <button class="filter-btn" data-filter="Verified">Verified</button>
          <button class="filter-btn" data-filter="Reopened">Reopened</button>
        </div>
      </div>
    </div>

    <!-- Staff ticket table -->
    <div class="staff-table-wrap">
      <table class="staff-table" id="staff-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Category</th>
            <th>Location</th>
            <th>Priority</th>
            <th>Reporter</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Votes</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staff-tbody">
        </tbody>
      </table>
      <div class="empty-state" id="staff-empty">
        <p>üì≠ No tickets match the current filter.</p>
      </div>
    </div>
  </main>

  <script>
    /* ============================================================
       CampusFixit ‚Äî Application Logic (v2)
       Staff Panel ¬∑ Verification Workflow ¬∑ Activity Logs
       ============================================================ */

    (() => {
      'use strict';

      // ‚îÄ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ
      const STORAGE_KEY = 'campusfixit_tickets';
      const THEME_KEY   = 'campusfixit_theme';
      const STAFF_KEY   = 'campusfixit_staff_name';

      const MOCK_LOCATIONS = [
        'Lab 4, Block B', 'Room 201, Block A', 'Lecture Hall 3, Block C',
        'Library, 2nd Floor', 'Cafeteria, Ground Floor', 'Admin Office, Block D',
        'Computer Lab 2, Block B', 'Workshop 1, Block E',
        'Seminar Room 5, Block A', 'Room 302, Block C',
      ];

      // ‚îÄ‚îÄ‚îÄ‚îÄ DOM References ‚îÄ‚îÄ‚îÄ‚îÄ
      // Student
      const form          = document.getElementById('ticket-form');
      const reporterEl    = document.getElementById('reporter');
      const categoryEl    = document.getElementById('category');
      const locationEl    = document.getElementById('location');
      const priorityEl    = document.getElementById('priority');
      const descriptionEl = document.getElementById('description');
      const scanQrBtn     = document.getElementById('scan-qr');
      const ticketsGrid   = document.getElementById('tickets-grid');
      const emptyState    = document.getElementById('empty-state');
      const studentFilters = document.querySelectorAll('#student-filters .filter-btn');

      // Staff
      const staffTbody    = document.getElementById('staff-tbody');
      const staffEmpty    = document.getElementById('staff-empty');
      const staffNameEl   = document.getElementById('staff-name');
      const staffFilters  = document.querySelectorAll('#staff-filters .filter-btn');

      // Stats
      const statTotal    = document.getElementById('stat-total');
      const statPending  = document.getElementById('stat-pending');
      const statProgress = document.getElementById('stat-progress');
      const statFixed    = document.getElementById('stat-fixed');
      const statVerified = document.getElementById('stat-verified');

      // Views & Role
      const studentView  = document.getElementById('student-view');
      const staffView    = document.getElementById('staff-view');
      const roleBtns     = document.querySelectorAll('.role-btn');

      // Dark mode
      const darkToggle   = document.getElementById('dark-toggle');
      const darkIcon     = document.getElementById('dark-icon');

      // Toast
      const toastContainer = document.getElementById('toast-container');

      // Verify modal
      const verifyModal      = document.getElementById('verify-modal');
      const modalTicketInfo  = document.getElementById('modal-ticket-info');
      const verifyComment    = document.getElementById('verify-comment');
      const starRating       = document.getElementById('star-rating');
      const verifyAcceptBtn  = document.getElementById('verify-accept');
      const verifyRejectBtn  = document.getElementById('verify-reject');
      const verifyCancelBtn  = document.getElementById('verify-cancel');

      // Notes modal
      const notesModal       = document.getElementById('notes-modal');
      const notesTicketInfo  = document.getElementById('notes-ticket-info');
      const staffNoteInput   = document.getElementById('staff-note-input');
      const addNoteBtn       = document.getElementById('add-note-btn');
      const activityLog      = document.getElementById('activity-log');
      const notesCloseBtn    = document.getElementById('notes-close');

      // ‚îÄ‚îÄ‚îÄ‚îÄ Seed Data ‚îÄ‚îÄ‚îÄ‚îÄ
      const SEED_DATA = [
        {
          id: '#TCKT-9B2A', category: 'üíª IT/Projector', location: 'Lecture Hall 3, Block C',
          priority: 'High', reporter: 'Arjun Mehta',
          description: 'Projector displays a flickering image and sometimes shuts off mid-lecture. Already tried restarting it twice.',
          status: 'Pending', assignedTo: '', createdAt: new Date(Date.now() - 1000*60*12).toISOString(),
          log: [{ time: new Date(Date.now() - 1000*60*12).toISOString(), actor: 'Arjun Mehta', text: 'Ticket created', type: 'system' }],
          rating: 0, verifyComment: '', votes: 12,
        },
        {
          id: '#TCKT-4FX7', category: '‚ùÑÔ∏è AC/Ventilation', location: 'Room 201, Block A',
          priority: 'Medium', reporter: 'Priya Sharma',
          description: 'AC unit is blowing warm air. Temperature in the room is around 32 ¬∞C. Students unable to focus.',
          status: 'Assigned', assignedTo: 'Rajesh Kumar', createdAt: new Date(Date.now() - 1000*60*45).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*45).toISOString(), actor: 'Priya Sharma', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*30).toISOString(), actor: 'Rajesh Kumar', text: 'Assigned to self', type: 'system' },
          ],
          rating: 0, verifyComment: '', votes: 7,
        },
        {
          id: '#TCKT-L8QW', category: 'ü™ë Furniture', location: 'Library, 2nd Floor',
          priority: 'Low', reporter: 'Sneha Patel',
          description: 'Two chairs near the group-study table have broken armrests. Not urgent but could be a safety hazard.',
          status: 'Fixed', assignedTo: 'Anil Verma', votes: 3, createdAt: new Date(Date.now() - 1000*60*60*3).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*60*3).toISOString(), actor: 'Sneha Patel', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*2).toISOString(), actor: 'Anil Verma', text: 'Assigned to self', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*1.5).toISOString(), actor: 'Anil Verma', text: 'Started work', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60).toISOString(), actor: 'Anil Verma', text: 'Replaced both armrests. Chairs are good to use.', type: 'note' },
            { time: new Date(Date.now() - 1000*60*55).toISOString(), actor: 'Anil Verma', text: 'Marked as Fixed ‚Äî awaiting student verification', type: 'system' },
          ],
          rating: 0, verifyComment: '',
        },
        {
          id: '#TCKT-P3MN', category: 'üì∂ WiFi/Network', location: 'Cafeteria, Ground Floor',
          priority: 'High', reporter: 'Rahul Gupta',
          description: 'WiFi keeps dropping every 5 minutes. Multiple students and staff affected. Tried reconnecting ‚Äî same issue.',
          status: 'In Progress', assignedTo: 'Deepak IT', votes: 24, createdAt: new Date(Date.now() - 1000*60*25).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*25).toISOString(), actor: 'Rahul Gupta', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*20).toISOString(), actor: 'Deepak IT', text: 'Assigned to self', type: 'system' },
            { time: new Date(Date.now() - 1000*60*15).toISOString(), actor: 'Deepak IT', text: 'Started work', type: 'system' },
            { time: new Date(Date.now() - 1000*60*10).toISOString(), actor: 'Deepak IT', text: 'Checking router logs. Possible firmware issue.', type: 'note' },
          ],
          rating: 0, verifyComment: '',
        },
        {
          id: '#TCKT-7RKJ', category: 'üí° Lighting', location: 'Computer Lab 2, Block B',
          priority: 'Medium', reporter: 'Kavya Nair',
          description: 'Three fluorescent tube lights are flickering constantly, causing eye strain during evening lab sessions.',
          status: 'Assigned', assignedTo: 'Suresh Electricals', createdAt: new Date(Date.now() - 1000*60*60).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*60).toISOString(), actor: 'Kavya Nair', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*50).toISOString(), actor: 'Suresh Electricals', text: 'Assigned to self', type: 'system' },
          ],
          rating: 0, verifyComment: '', votes: 5,
        },
        {
          id: '#TCKT-2VZD', category: 'üöø Plumbing', location: 'Admin Office, Block D',
          priority: 'High', reporter: 'Meena Iyer',
          description: 'Washroom tap on the 1st floor is leaking non-stop. Water pooling on the floor ‚Äî slip hazard.',
          status: 'Pending', assignedTo: '', createdAt: new Date(Date.now() - 1000*60*8).toISOString(),
          log: [{ time: new Date(Date.now() - 1000*60*8).toISOString(), actor: 'Meena Iyer', text: 'Ticket created', type: 'system' }],
          rating: 0, verifyComment: '', votes: 18,
        },
        {
          id: '#TCKT-BNXC', category: 'üîå Electrical', location: 'Workshop 1, Block E',
          priority: 'High', reporter: 'Vikram Singh',
          description: 'Power socket near workstation 4 is sparking when plugs are inserted. Please cut the breaker and inspect.',
          status: 'In Progress', assignedTo: 'Suresh Electricals', votes: 9, createdAt: new Date(Date.now() - 1000*60*90).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*90).toISOString(), actor: 'Vikram Singh', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*80).toISOString(), actor: 'Suresh Electricals', text: 'Assigned to self', type: 'system' },
            { time: new Date(Date.now() - 1000*60*70).toISOString(), actor: 'Suresh Electricals', text: 'Started work ‚Äî breaker has been turned off', type: 'system' },
            { time: new Date(Date.now() - 1000*60*50).toISOString(), actor: 'Suresh Electricals', text: 'Internal wiring damaged. Replacing socket unit.', type: 'note' },
          ],
          rating: 0, verifyComment: '',
        },
        {
          id: '#TCKT-6GTH', category: 'üßπ Cleaning', location: 'Seminar Room 5, Block A',
          priority: 'Low', reporter: 'Ananya Das',
          description: 'Room was not cleaned after a workshop yesterday. Dusty tables, leftover food wrappers on the floor.',
          status: 'Verified', assignedTo: 'Housekeeping Team', votes: 2, createdAt: new Date(Date.now() - 1000*60*60*5).toISOString(),
          log: [
            { time: new Date(Date.now() - 1000*60*60*5).toISOString(), actor: 'Ananya Das', text: 'Ticket created', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*4).toISOString(), actor: 'Housekeeping Team', text: 'Assigned to self', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*3.5).toISOString(), actor: 'Housekeeping Team', text: 'Started work', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*3).toISOString(), actor: 'Housekeeping Team', text: 'Room fully cleaned and sanitized.', type: 'note' },
            { time: new Date(Date.now() - 1000*60*60*2.8).toISOString(), actor: 'Housekeeping Team', text: 'Marked as Fixed ‚Äî awaiting verification', type: 'system' },
            { time: new Date(Date.now() - 1000*60*60*2).toISOString(), actor: 'Ananya Das', text: 'Verified ‚úÖ ‚Äî Room looks great! (Rating: ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ)', type: 'system' },
          ],
          rating: 5, verifyComment: 'Room looks great!',
        },
      ];

      // ‚îÄ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ
      let tickets         = loadTickets();
      let activeRole      = 'student';
      let studentFilter   = 'All';
      let staffFilter     = 'All';
      let verifyingTicketId = null;
      let selectedRating  = 0;
      let notesTicketId   = null;

      // Seed on first visit
      if (tickets.length === 0) {
        tickets = SEED_DATA;
        saveTickets();
      }

      // Restore staff name
      staffNameEl.value = localStorage.getItem(STAFF_KEY) || '';
      staffNameEl.addEventListener('input', () => {
        localStorage.setItem(STAFF_KEY, staffNameEl.value.trim());
      });

      // ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ
      applyTheme();
      renderAll();

      // ============================================================
      //  EVENT LISTENERS
      // ============================================================

      // --- Role switching ---
      roleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          roleBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeRole = btn.dataset.role;
          if (activeRole === 'student') {
            studentView.classList.remove('hidden');
            staffView.classList.add('hidden');
          } else {
            studentView.classList.add('hidden');
            staffView.classList.remove('hidden');
          }
          renderAll();
        });
      });

      // --- Dark mode ---
      darkToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        darkIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
      });

      // --- Student: submit ---
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const ticket = {
          id:          generateId(),
          category:    categoryEl.value,
          location:    locationEl.value.trim(),
          priority:    priorityEl.value,
          reporter:    reporterEl.value.trim(),
          description: descriptionEl.value.trim(),
          status:      'Pending',
          assignedTo:  '',
          createdAt:   new Date().toISOString(),
          log:         [{ time: new Date().toISOString(), actor: reporterEl.value.trim(), text: 'Ticket created', type: 'system' }],
          rating:      0,
          verifyComment: '',
          votes:       0,
        };
        tickets.unshift(ticket);
        saveTickets();
        renderAll();
        form.reset();
        showToast(`‚úÖ Ticket ${ticket.id} submitted!`);
      });

      // --- QR scan mock ---
      scanQrBtn.addEventListener('click', () => {
        scanQrBtn.classList.add('scanning');
        scanQrBtn.innerHTML = '<span class="qr-spinner"></span> Scanning‚Ä¶';
        setTimeout(() => {
          const loc = MOCK_LOCATIONS[Math.floor(Math.random() * MOCK_LOCATIONS.length)];
          locationEl.value = loc;
          scanQrBtn.classList.remove('scanning');
          scanQrBtn.innerHTML = 'üì∑ Scan QR';
          showToast(`üìç Location detected: ${loc}`);
        }, 1200);
      });

      // --- Student filters ---
      studentFilters.forEach(btn => {
        btn.addEventListener('click', () => {
          studentFilters.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          studentFilter = btn.dataset.filter;
          renderStudentDashboard();
        });
      });

      // --- Staff filters ---
      staffFilters.forEach(btn => {
        btn.addEventListener('click', () => {
          staffFilters.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          staffFilter = btn.dataset.filter;
          renderStaffTable();
        });
      });

      // --- Student card actions (verify, delete, upvote) ---
      ticketsGrid.addEventListener('click', (e) => {
        const verifyBtn = e.target.closest('.btn-verify');
        if (verifyBtn) {
          openVerifyModal(verifyBtn.dataset.ticketId);
          return;
        }
        const upvoteBtn = e.target.closest('.btn-upvote');
        if (upvoteBtn) {
          const ticketId = upvoteBtn.dataset.ticketId;
          const ticket = tickets.find(t => t.id === ticketId);
          if (ticket) {
            const votedSet = getVotedSet();
            if (votedSet.has(ticketId)) {
              // Un-vote
              ticket.votes = Math.max(0, (ticket.votes || 0) - 1);
              votedSet.delete(ticketId);
              saveVotedSet(votedSet);
              showToast(`üëé Vote removed from ${ticketId}`);
            } else {
              // Upvote
              ticket.votes = (ticket.votes || 0) + 1;
              votedSet.add(ticketId);
              saveVotedSet(votedSet);
              showToast(`üëç Upvoted ${ticketId} ‚Äî ${ticket.votes} votes`);
            }
            saveTickets();
            renderAll();
          }
          return;
        }
        const delBtn = e.target.closest('.delete-btn');
        if (delBtn) {
          tickets = tickets.filter(t => t.id !== delBtn.dataset.ticketId);
          saveTickets();
          renderAll();
          showToast(`üóëÔ∏è Ticket deleted`);
        }
      });

      // --- Staff table actions (delegated) ---
      document.getElementById('staff-table').addEventListener('click', (e) => {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;
        const id = btn.dataset.ticketId;
        const action = btn.dataset.action;
        const ticket = tickets.find(t => t.id === id);
        if (!ticket) return;

        const staffName = staffNameEl.value.trim() || 'Staff';

        switch (action) {
          case 'assign':
            ticket.status = 'Assigned';
            ticket.assignedTo = staffName;
            addLog(ticket, staffName, 'Assigned to self', 'system');
            showToast(`üìå ${id} assigned to ${staffName}`);
            break;
          case 'progress':
            ticket.status = 'In Progress';
            addLog(ticket, staffName, 'Started work', 'system');
            showToast(`üî® ${id} ‚Üí In Progress`);
            break;
          case 'done':
            ticket.status = 'Fixed';
            addLog(ticket, staffName, 'Marked as Fixed ‚Äî awaiting student verification', 'system');
            showToast(`‚úÖ ${id} ‚Üí Fixed (awaiting verification)`);
            break;
          case 'notes':
            openNotesModal(id);
            return;
        }

        saveTickets();
        renderAll();
      });

      // ============================================================
      //  VERIFY MODAL
      // ============================================================

      function openVerifyModal(ticketId) {
        verifyingTicketId = ticketId;
        selectedRating = 0;
        const t = tickets.find(t => t.id === ticketId);
        modalTicketInfo.textContent = `${t.id} ‚Äî ${t.category} @ ${t.location}`;
        verifyComment.value = '';
        starRating.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
        verifyModal.classList.remove('hidden');
      }

      starRating.addEventListener('click', (e) => {
        const star = e.target.closest('.star');
        if (!star) return;
        selectedRating = parseInt(star.dataset.val);
        starRating.querySelectorAll('.star').forEach(s => {
          s.classList.toggle('active', parseInt(s.dataset.val) <= selectedRating);
        });
      });

      starRating.addEventListener('mouseover', (e) => {
        const star = e.target.closest('.star');
        if (!star) return;
        const val = parseInt(star.dataset.val);
        starRating.querySelectorAll('.star').forEach(s => {
          s.classList.toggle('active', parseInt(s.dataset.val) <= val);
        });
      });

      starRating.addEventListener('mouseleave', () => {
        starRating.querySelectorAll('.star').forEach(s => {
          s.classList.toggle('active', parseInt(s.dataset.val) <= selectedRating);
        });
      });

      verifyAcceptBtn.addEventListener('click', () => {
        const t = tickets.find(t => t.id === verifyingTicketId);
        if (!t) return;
        t.status = 'Verified';
        t.rating = selectedRating;
        t.verifyComment = verifyComment.value.trim();
        const ratingStr = selectedRating > 0 ? ` (Rating: ${'‚òÖ'.repeat(selectedRating)}${'‚òÜ'.repeat(5 - selectedRating)})` : '';
        const commentStr = t.verifyComment ? ` ‚Äî ${t.verifyComment}` : '';
        addLog(t, t.reporter, `Verified ‚úÖ${commentStr}${ratingStr}`, 'system');
        saveTickets();
        verifyModal.classList.add('hidden');
        renderAll();
        showToast(`‚úÖ ${t.id} verified! Thank you.`);
      });

      verifyRejectBtn.addEventListener('click', () => {
        const t = tickets.find(t => t.id === verifyingTicketId);
        if (!t) return;
        t.status = 'Reopened';
        const commentStr = verifyComment.value.trim() ? ` ‚Äî ${verifyComment.value.trim()}` : '';
        addLog(t, t.reporter, `Reopened üîÑ Issue not resolved${commentStr}`, 'system');
        saveTickets();
        verifyModal.classList.add('hidden');
        renderAll();
        showToast(`üîÑ ${t.id} reopened ‚Äî staff will be notified.`);
      });

      verifyCancelBtn.addEventListener('click', () => {
        verifyModal.classList.add('hidden');
      });

      verifyModal.addEventListener('click', (e) => {
        if (e.target === verifyModal) verifyModal.classList.add('hidden');
      });

      // ============================================================
      //  NOTES MODAL
      // ============================================================

      function openNotesModal(ticketId) {
        notesTicketId = ticketId;
        const t = tickets.find(t => t.id === ticketId);
        notesTicketInfo.textContent = `${t.id} ‚Äî ${t.category} @ ${t.location}`;
        staffNoteInput.value = '';
        renderActivityLog(t);
        notesModal.classList.remove('hidden');
      }

      addNoteBtn.addEventListener('click', () => {
        const text = staffNoteInput.value.trim();
        if (!text) return;
        const t = tickets.find(t => t.id === notesTicketId);
        if (!t) return;
        const staffName = staffNameEl.value.trim() || 'Staff';
        addLog(t, staffName, text, 'note');
        saveTickets();
        staffNoteInput.value = '';
        renderActivityLog(t);
        showToast('üìù Note added');
      });

      notesCloseBtn.addEventListener('click', () => {
        notesModal.classList.add('hidden');
      });

      notesModal.addEventListener('click', (e) => {
        if (e.target === notesModal) notesModal.classList.add('hidden');
      });

      function renderActivityLog(ticket) {
        if (!ticket.log || ticket.log.length === 0) {
          activityLog.innerHTML = '<p style="color:var(--text-muted);font-size:.85rem;">No activity yet.</p>';
          return;
        }
        const visibleLog = activeRole === 'staff'
          ? ticket.log
          : ticket.log.filter(entry => entry.type !== 'note');

        if (visibleLog.length === 0) {
          activityLog.innerHTML = '<p style="color:var(--text-muted);font-size:.85rem;">No activity yet.</p>';
          return;
        }
        activityLog.innerHTML = [...visibleLog].reverse().map(entry => `
          <div class="log-entry log-${entry.type}">
            <span class="log-time">${formatTime(entry.time)}</span>
            <span class="log-actor">${escapeHTML(entry.actor)}</span>:
            <span class="log-text">${escapeHTML(entry.text)}</span>
          </div>
        `).join('');
      }

      // ============================================================
      //  RENDER FUNCTIONS
      // ============================================================

      function renderAll() {
        renderStudentDashboard();
        renderStaffTable();
        renderStats();
      }

      // --- Student Dashboard ---
      function renderStudentDashboard() {
        const filtered = studentFilter === 'All'
          ? tickets
          : tickets.filter(t => t.status === studentFilter);

        ticketsGrid.querySelectorAll('.ticket-card').forEach(c => c.remove());

        if (filtered.length === 0) {
          emptyState.style.display = '';
          return;
        }
        emptyState.style.display = 'none';

        filtered.forEach(t => {
          const card = document.createElement('div');
          card.className = `ticket-card priority-${t.priority}`;

          let actionsHTML = '';
          if (t.status === 'Fixed') {
            actionsHTML = `<button class="btn-verify" data-ticket-id="${t.id}">üîç Verify Fix</button>`;
          } else if (t.status === 'Verified') {
            const stars = t.rating > 0 ? `<span class="star-display">${'‚òÖ'.repeat(t.rating)}${'‚òÜ'.repeat(5 - t.rating)}</span>` : '';
            actionsHTML = `<span class="verified-stamp">‚úÖ Verified ${stars}</span>`;
          }

          const assignedHTML = t.assignedTo
            ? `<div class="card-assigned">üîß ${escapeHTML(t.assignedTo)}</div>`
            : '';

          const statusClass = t.status.replace(/\s/g, '-');
          const voteCount = t.votes || 0;
          const votedSet = getVotedSet();
          const hasVoted = votedSet.has(t.id);
          const hotClass = voteCount >= 10 ? ' vote-hot' : voteCount >= 5 ? ' vote-warm' : '';

          card.innerHTML = `
            <div class="card-top">
              <span class="ticket-id">${t.id}</span>
              <span class="ticket-time">${formatTime(t.createdAt)}</span>
            </div>
            <div class="card-category">${t.category}</div>
            <div class="card-location">üìå ${escapeHTML(t.location)}</div>
            <div class="card-reporter">üë§ Reported by ${escapeHTML(t.reporter)}</div>
            ${assignedHTML}
            <p class="card-desc">${escapeHTML(t.description)}</p>
            <div class="card-vote-row">
              <button class="btn-upvote${hasVoted ? ' voted' : ''}${hotClass}" data-ticket-id="${t.id}" title="${hasVoted ? 'Remove vote' : 'Upvote this issue'}">
                <span class="upvote-arrow">‚ñ≤</span>
                <span class="upvote-count">${voteCount}</span>
              </button>
              <span class="vote-label${hotClass}">${voteCount >= 10 ? 'üî• Hot Issue' : voteCount >= 5 ? '‚ö†Ô∏è Gaining attention' : 'Upvote if affected'}</span>
            </div>
            <div class="card-bottom">
              <span class="status-badge status-${statusClass}">${t.status}</span>
              <div style="display:flex;align-items:center;gap:6px;">
                ${actionsHTML}
                <button class="delete-btn" data-ticket-id="${t.id}" title="Delete ticket">üóëÔ∏è</button>
              </div>
            </div>
          `;

          ticketsGrid.appendChild(card);
        });
      }

      // --- Staff Table ---
      function renderStaffTable() {
        const filtered = staffFilter === 'All'
          ? tickets
          : tickets.filter(t => t.status === staffFilter);

        staffTbody.innerHTML = '';

        if (filtered.length === 0) {
          staffEmpty.style.display = '';
          document.getElementById('staff-table').style.display = 'none';
          return;
        }
        staffEmpty.style.display = 'none';
        document.getElementById('staff-table').style.display = '';

        filtered.forEach(t => {
          const tr = document.createElement('tr');
          const statusClass = t.status.replace(/\s/g, '-');

          let actionsHTML = '';
          if (t.status === 'Pending' || t.status === 'Reopened') {
            actionsHTML += `<button class="action-btn assign" data-ticket-id="${t.id}" data-action="assign">üìå Assign</button>`;
          }
          if (t.status === 'Assigned') {
            actionsHTML += `<button class="action-btn progress" data-ticket-id="${t.id}" data-action="progress">‚ñ∂ Start</button>`;
          }
          if (t.status === 'In Progress') {
            actionsHTML += `<button class="action-btn done" data-ticket-id="${t.id}" data-action="done">‚úÖ Mark Done</button>`;
          }
          actionsHTML += `<button class="action-btn notes" data-ticket-id="${t.id}" data-action="notes">üìù Notes</button>`;

          const voteCount = t.votes || 0;
          const hotBadge = voteCount >= 10 ? ' üî•' : voteCount >= 5 ? ' ‚ö†Ô∏è' : '';

          tr.innerHTML = `
            <td><span class="ticket-id">${t.id}</span></td>
            <td>${t.category}</td>
            <td>${escapeHTML(t.location)}</td>
            <td><span class="priority-dot ${t.priority}"></span>${t.priority}</td>
            <td>${escapeHTML(t.reporter)}</td>
            <td><span class="status-badge status-${statusClass}">${t.status}</span></td>
            <td>${t.assignedTo ? escapeHTML(t.assignedTo) : '<span style="color:var(--text-muted)">‚Äî</span>'}</td>
            <td class="vote-cell"><span class="vote-count-badge${voteCount >= 10 ? ' vote-hot' : voteCount >= 5 ? ' vote-warm' : ''}">‚ñ≤ ${voteCount}${hotBadge}</span></td>
            <td style="white-space:nowrap;">${formatTime(t.createdAt)}</td>
            <td><div class="staff-actions">${actionsHTML}</div></td>
          `;

          staffTbody.appendChild(tr);
        });
      }

      // --- Stats ---
      function renderStats() {
        statTotal.textContent    = tickets.length;
        statPending.textContent  = tickets.filter(t => t.status === 'Pending' || t.status === 'Reopened').length;
        statProgress.textContent = tickets.filter(t => t.status === 'Assigned' || t.status === 'In Progress').length;
        statFixed.textContent    = tickets.filter(t => t.status === 'Fixed').length;
        statVerified.textContent = tickets.filter(t => t.status === 'Verified').length;
      }

      // ============================================================
      //  HELPERS
      // ============================================================

      function generateId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
        return `#TCKT-${code}`;
      }

      function formatTime(iso) {
        const d = new Date(iso);
        return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }

      function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function addLog(ticket, actor, text, type) {
        if (!ticket.log) ticket.log = [];
        ticket.log.push({ time: new Date().toISOString(), actor, text, type });
      }

      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3200);
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ
      function loadTickets() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        catch { return []; }
      }

      function saveTickets() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
      }

      function applyTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === 'dark') {
          document.body.classList.add('dark');
          darkIcon.textContent = '‚òÄÔ∏è';
        }
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ Voting Persistence ‚îÄ‚îÄ‚îÄ‚îÄ
      const VOTED_KEY = 'campusfixit_voted';

      function getVotedSet() {
        try {
          return new Set(JSON.parse(localStorage.getItem(VOTED_KEY)) || []);
        } catch { return new Set(); }
      }

      function saveVotedSet(set) {
        localStorage.setItem(VOTED_KEY, JSON.stringify([...set]));
      }

    })();
  </script>
</body>
</html>